<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="dashboard-header">
  <h2 class="dashboard-title">Missed Punch Requests</h2>
  <nav class="breadcrumb">
    <a href="#">Home</a> &gt;
    <a href="#">Attendance</a> &gt;
    <span>Missed Punch Requests</span>
  </nav>
</div>

<div class="tab-container mt-4">
  <input type="radio" id="tab1" name="tab" checked (change)="loadMyRequests()">
  <input type="radio" id="tab2" name="tab" (change)="loadPendingApprovals()">

  <div class="tab-header">
    <label class="tab-label" for="tab1">My Requests</label>
    <label class="tab-label" for="tab2">Manager Approval</label>
  </div>

  <!-- My Requests Tab -->
  <div id="content1" class="tab-content">
    <div class="card p-4 shadow-sm mb-4">
      <h5 class="mb-3">Submit Missed Punch Request</h5>
      <form [formGroup]="requestForm" (ngSubmit)="submitRequest()">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" formControlName="MissedDate" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Missed Type <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="MissedTypeID" required>
              <option [ngValue]="null">Select Type</option>
              <option *ngFor="let type of missedTypes" [ngValue]="type.missedTypeID">
                {{ type.missedType }}
              </option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Clock In</label>
            <input type="time" class="form-control" formControlName="CorrectClockIn">
          </div>
          <div class="col-md-6">
            <label class="form-label">Clock Out</label>
            <input type="time" class="form-control" formControlName="CorrectClockOut">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Reason <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" formControlName="Reason"></textarea>
          </div>
        </div>
       <div class="text-start">
  <button type="submit" class="btn btn-primary" [disabled]="requestForm.invalid || isSubmitting">
    Submit Request
  </button>
  <!-- Spinner -->
  <div *ngIf="isSubmitting" class="loader" style="margin-left: 10px;"></div>
</div>
      </form>
    </div>

    <div class="card p-4 shadow-sm">
      <h5 class="mb-3">My Missed Punch Requests</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Missed Type</th>
              <th>Clock In</th>
              <th>Clock Out</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let req of pagedMyRequests">
              <td>{{ req.missedDate | date:'yyyy-MM-dd' }}</td>
              <td>{{ req.missedType || '-' }}</td>
              <td>{{ req.correctClockIn ? (req.correctClockIn | date:'HH:mm') : '-' }}</td>
              <td>{{ req.correctClockOut ? (req.correctClockOut | date:'HH:mm') : '-' }}</td>
              <td>{{ req.reason || '-' }}</td>
              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-warning text-dark': req.status==='Pending',
                        'bg-success': req.status==='Approved',
                        'bg-danger': req.status==='Rejected'
                      }">
                  {{ req.status || '-' }}
                </span>
              </td>
              <td class="text-center">
                <a href="#" data-bs-toggle="modal" data-bs-target="#viewMissedModal" (click)="selectRequest(req)">
                  <i class="fa-solid fa-eye text-primary"></i>
                </a>
              </td>
            </tr>
            <tr *ngIf="myRequests.length === 0">
              <td colspan="7" class="text-center">No requests found</td>
            </tr>
          </tbody>
        </table>
      </div>

      <nav *ngIf="myRequests.length > pageSize">
        <ul class="pagination justify-content-center mt-3">
          <li class="page-item" [class.disabled]="myRequestsPage===1">
            <a class="page-link" (click)="changePageMyRequests(myRequestsPage-1)">Previous</a>
          </li>
          <li class="page-item" *ngFor="let p of [].constructor(totalMyRequestsPages()); let i = index" [class.active]="myRequestsPage===i+1">
            <a class="page-link" (click)="changePageMyRequests(i+1)">{{ i+1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="myRequestsPage===totalMyRequestsPages()">
            <a class="page-link" (click)="changePageMyRequests(myRequestsPage+1)">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Manager Approval Tab -->
  <div id="content2" class="tab-content">
    <div class="card p-4 shadow-sm">
      <h5 class="mb-3">Pending Missed Punch Approvals</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Select</th>
              <th>Employee</th>
              <th>Date</th>
              <th>Missed Type</th>
              <th>Clock In</th>
              <th>Clock Out</th>
              <th>Reason</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let req of pagedPendingApprovals">
              <td class="text-center">
                <input type="checkbox"
                       [disabled]="req.status !== 'Pending'"
                       [checked]="pendingSelections[req.missedPunchRequestID].selected"
                       (change)="toggleSelection(req)">
              </td>
              <td>{{ req.employeeID }}</td>
              <td>{{ req.missedDate | date:'yyyy-MM-dd' }}</td>
              <td>{{ req.missedType || '-' }}</td>
              <td>{{ req.correctClockIn ? (req.correctClockIn | date:'HH:mm') : '-' }}</td>
              <td>{{ req.correctClockOut ? (req.correctClockOut | date:'HH:mm') : '-' }}</td>
              <td>{{ req.reason || '-' }}</td>
              <td>
                <input type="text"
                       class="form-control form-control-sm"
                       [disabled]="req.status !== 'Pending'"
                       [value]="pendingSelections[req.missedPunchRequestID].comment"
                       (input)="updateComment(req, $any($event.target).value)">
              </td>
            </tr>
            <tr *ngIf="pendingApprovals.length === 0">
              <td colspan="8" class="text-center">No pending approvals</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-3 text-end">
        <button class="btn btn-success me-2" (click)="bulkAction('Approved')">Approve Selected</button>
        <button class="btn btn-danger" (click)="bulkAction('Rejected')">Reject Selected</button>
      </div>

      <nav *ngIf="pendingApprovals.length > pageSize">
        <ul class="pagination justify-content-center mt-3">
          <li class="page-item" [class.disabled]="pendingApprovalsPage===1">
            <a class="page-link" (click)="changePagePendingApprovals(pendingApprovalsPage-1)">Previous</a>
          </li>
          <li class="page-item" *ngFor="let p of [].constructor(totalPendingApprovalsPages()); let i = index" [class.active]="pendingApprovalsPage===i+1">
            <a class="page-link" (click)="changePagePendingApprovals(i+1)">{{ i+1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="pendingApprovalsPage===totalPendingApprovalsPages()">
            <a class="page-link" (click)="changePagePendingApprovals(pendingApprovalsPage+1)">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewMissedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" *ngIf="selectedRequest">
      <div class="modal-header">
        <h5 class="modal-title">Missed Punch Request Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Date:</strong> {{ selectedRequest.missedDate | date:'yyyy-MM-dd' }}</p>
        <p><strong>Missed Type:</strong> {{ selectedRequest.missedType }}</p>
        <p><strong>Clock In:</strong> {{ selectedRequest.correctClockIn ? (selectedRequest.correctClockIn | date:'HH:mm') : '-' }}</p>
        <p><strong>Clock Out:</strong> {{ selectedRequest.correctClockOut ? (selectedRequest.correctClockOut | date:'HH:mm') : '-' }}</p>
        <p><strong>Reason:</strong> {{ selectedRequest.reason }}</p>
        <p><strong>Status:</strong> {{ selectedRequest.status }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>
