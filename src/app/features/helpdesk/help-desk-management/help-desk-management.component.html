<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="dashboard-header">
  <h2 class="dashboard-title">Help Desk</h2>
  <nav class="breadcrumb">
    <a href="#">Home</a> &gt;
    <a href="#">Support</a> &gt;
    <span>Help Desk</span>
  </nav>
</div>

<div class="tab-container">
  <input type="radio" id="tab1" name="tab" checked>
  <input type="radio" id="tab2" name="tab">
  <input type="radio" id="tab3" name="tab">

  <div class="tab-header">
    <label class="tab-label" for="tab1">Raise Ticket</label>
    <label class="tab-label" for="tab2">My Tickets</label>
    <label class="tab-label" for="tab3">Ticket Approval</label>
  </div>

  <!-- TAB 1: Raise Ticket -->
  <div id="content1" class="tab-content">
    <form #raiseTicketForm="ngForm" (ngSubmit)="onSubmit()" novalidate>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Employee Name / ID</label>
          <input type="text" class="form-control" [value]="employeeId" placeholder="Auto-filled Employee Name / ID" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Department</label>
          <input type="text" class="form-control" [value]="departmentName"name="departmentID" placeholder="Auto-filled Department" readonly >
        </div>
        <div class="col-md-4">
          <label class="form-label">Category <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="raiseTicket.categoryId" name="categoryID" required>
            <option value="">Select Category</option>
            <option value="1">IT Support</option>
            <option value="2">Payroll</option>
            <option value="3">Leave/Attendance</option>
            <option value="4">HR Query</option>
            <option value="5">Other</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Issue Subject <span class="text-danger">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="raiseTicket.subjectIssue" placeholder="Enter subject" name="subjectIssue" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Priority <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="raiseTicket.priority" name="priority" required>
            <option value="">Select Priority</option>
            <option value="1">Low</option>
            <option value="2">Medium</option>
            <option value="3">High</option>
            <option value="4">Critical</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-12">
          <label class="form-label">Description <span class="text-danger">*</span></label>
          <textarea class="form-control" rows="4"[(ngModel)]="raiseTicket.description" name="description" placeholder="Describe your issue in detail" required></textarea>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Attachment (optional)</label>
          <input type="file" class="form-control" accept=".pdf,.docx,.jpg,.png">
        </div>
        <!-- Action Buttons -->
      <div class="col-md-6 text-end align-self-end">
        <button class="btn btn-success me-2" type="submit" [disabled]="!raiseTicketForm.valid">
          <i class="fa-solid fa-save me-2"></i>{{ isEditMode ? 'Update' : 'Submit' }}
        </button>
        <button class="btn btn-secondary" type="button" (click)="resetForm()">
          <i class="fa-solid fa-rotate-left me-2"></i>Reset
        </button>
      </div>
        
      </div>
    </form>
     <!-- List of Raised Tickets -->
  <div class="card mt-3">
    <h3 class="section-title">My Raised Tickets</h3>

    <!-- Filter Bar -->
  

    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Ticket ID</th>
          <th>Category</th>
          <th>Subject</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Raised On</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of raiseTicketList">
          <td>#TK{{ ticket.raiseTicketId }}</td>
          <td>{{ categoryLabels[ticket.categoryId] }}</td>
          <td>{{ ticket.subjectIssue }}</td>
          <td><span class="priority {{ priorityLabels[ticket.priority] | lowercase }}">{{ priorityLabels[ticket.priority] }}</span></td>
          <td><span class="status {{ ticket.status | lowercase }}">{{ ticket.status }}</span></td>
          <td>{{ ticket.createdDate | date:'dd-MMM-yyyy' }}</td>
          <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="editTicket(ticket)">
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteTicket(ticket)">
                  <i class="fa-solid fa-trash"></i>
                </button>
          </td>
        </tr>
        
      </tbody>
    </table>
  </div>
  </div>

  <!-- TAB 2: My Tickets -->
 <!-- MY TICKETS TAB -->
<div id="content2" class="tab-content">

  <div class="card">
    <h3 class="section-title">My Tickets</h3>

    <!-- Filter Section -->
     <form class="filter-container mb-3" (ngSubmit)="applyFilters()">
  <div class="row">
    <div class="col-md-3">
      <label class="form-label">Category</label>
      <select class="form-select" [(ngModel)]="selectedCategory" name="categoryFilter">
        <option value="">All Categories</option>
        <option>IT Support</option>
        <option>Payroll</option>
        <option>HR Query</option>
        <option>Leave/Attendance</option>
        <option>Other</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select class="form-select" [(ngModel)]="selectedStatus" name="statusFilter">
        <option value="">All Status</option>
        <option>Open</option>
        <option>In Progress</option>
        <option>Resolved</option>
        <option>Closed</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Date Range</label>
      <input type="date" class="form-control" [(ngModel)]="selectedDate" name="dateFilter">
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary ms-2">Filter</button>
      <button type="button" class="btn btn-secondary ms-2" (click)="clearFilters()">Clear</button>

    </div>
  </div>
</form>

    <!-- Ticket Table -->
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Ticket ID</th>
          <th>Category</th>
          <th>Subject</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Raised On</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody>
        <tbody>
        <tr *ngFor="let ticket of pagedRaiseTickets">
          <td>#TK{{ ticket.raiseTicketId }}</td>
          <td>{{ categoryLabels[ticket.categoryId] }}</td>
          <td>{{ ticket.subjectIssue }}</td>
          <td><span class="priority {{ priorityLabels[ticket.priority] | lowercase }}">{{ priorityLabels[ticket.priority] }}</span></td>
          <td><span class="status {{ ticket.status | lowercase }}">{{ ticket.status }}</span></td>
          <td>{{ ticket.createdDate | date:'dd-MMM-yyyy' }}</td>
          <td>{{ ticket.modifiedAt | date:'dd-MMM-yyyy' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

  <!-- TAB 3: Ticket Approval -->
<!-- APPROVE TICKETS TAB -->
<div id="content3" class="tab-content">

  <div class="card">
    <h3 class="section-title">Approve Tickets</h3>

    <!-- Filter Section -->
    <!-- <form class="filter-container mb-3" (ngSubmit)="applyFilters()">
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Employee Name</label>
          <select class="form-select">
            <option value="">All Employees</option>
            <option>John Doe</option>
            <option>Mary Thomas</option>
            <option>Rajesh Kumar</option>
            <option>Fatima Ali</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select">
            <option value="">All Status</option>
            <option>Open</option>
            <option>In Progress</option>
            <option>Resolved</option>
            <option>Closed</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">From Date</label>
          <input type="date" class="form-control">
        </div>

        <div class="col-md-3">
          <label class="form-label">To Date</label>
          <input type="date" class="form-control">
        </div>
      </div>

      <div class="text-end mt-2">
        <button type="submit" class="btn btn-primary">Filter</button>
      </div>
    </form> -->

    <form class="filter-container mb-3">
  <div class="row">
    <div class="col-md-3">
      <label class="form-label">Employee</label>
      <input type="text" [(ngModel)]="selectedApprovalEmployee" (ngModelChange)="applyApprovalFilters()" class="form-control" placeholder="All Employees">
    </div>
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select class="form-select" [(ngModel)]="selectedApprovalStatus" (change)="applyApprovalFilters()">
        <option value="">All Status</option>
        <option>Open</option>
        <option>In Progress</option>
        <option>Resolved</option>
        <option>Closed</option>
        <option>Rejected</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Category</label>
      <select class="form-select" [(ngModel)]="selectedApprovalCategory" (change)="applyApprovalFilters()">
        <option value="">All Categories</option>
        <option *ngFor="let c of (categoryLabels | keyvalue)" [value]="c.value">{{ c.value }}</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Date</label>
      <input type="date" [(ngModel)]="selectedApprovalDate" (change)="applyApprovalFilters()" class="form-control">
    </div>
  </div>
</form>

    <!-- Ticket Table for Approval -->
    <table class="table table-bordered table-striped">
    <thead>
      <tr>
        
        <th><input type="checkbox" (change)="toggleAll($event)"></th>
        <th>Ticket ID</th>
        <th>Employee</th>
        <th>Category</th>
        <th>Subject</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Raised On</th>
        <th>Manager Comments</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let r of tickets">
        <td><input type="checkbox"
                   [checked]="selectedIds.has(r.raiseTicketApprovalId)"
                   (change)="toggleOne(r.raiseTicketApprovalId, $event)"></td>
        <td>#TK{{ r.raiseTicketId }}</td>
        <td>{{ r.employeeId }}</td> <!-- swap to employeeName if available in ticket API -->
        <td>{{ r.categoryName }}</td>
        <td>{{ r.subjectIssue }}</td>
        <td>{{ r.status }}</td>
        <td>{{ r.priorityLabel }}</td>
        <td>{{ r.createdDate | date:'dd-MMM-yyyy' }}</td>
        <td>
          <textarea class="form-control" rows="1"
          [value]="perRowComments.get(r.raiseTicketApprovalId) || ''"
          (input)="updateComment(r.raiseTicketApprovalId, $event)"
          placeholder="Add remarks..."></textarea>
        </td>
        <td>
          <select class="form-select"
        [value]="perRowStatuses.get(r.raiseTicketApprovalId) || ''"
        (change)="updateTicketStatus(r.raiseTicketApprovalId, $event)">
            <option value="">(default)</option>
            <option>Open</option>
            <option>In Progress</option>
            <option>Resolved</option>
            <option>Rejected</option>
            <option>Closed</option>
          </select>
        </td>
      </tr>
    </tbody>
  </table>


     

    <!-- Action Buttons -->
    <div class="action-buttons text-end mt-3">
      <button class="btn btn-success">Approve Selected</button>
      <button class="btn btn-danger">Reject Selected</button>
    </div>
  </div>
</div>
</div>

<app-footer></app-footer>
